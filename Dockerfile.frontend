# Frontend Dockerfile - Multi-stage build
FROM node:18-alpine AS builder

# Set working directory
WORKDIR /app

# Copy package files
COPY frontend/package*.json ./

# Install dependencies
RUN npm ci

# Copy frontend source code
COPY frontend/ ./

# Debug: Check what files are actually copied
RUN echo "=== Checking copied files ===" && \
    echo "Current directory:" && pwd && \
    echo "Contents of root:" && ls -la | head -20 && \
    echo "Looking for messages directories:" && \
    find . -name "messages" -type d 2>/dev/null | head -10 && \
    echo "Looking for JSON files:" && \
    find . -path "*/messages/*.json" 2>/dev/null | head -10 && \
    echo "Checking public directory:" && \
    ls -la public/ 2>/dev/null || echo "public/ directory not found" && \
    echo "Checking public/messages:" && \
    ls -la public/messages/ 2>/dev/null || echo "public/messages/ directory not found"

# Explicitly copy messages directory if it exists in a different location
RUN if [ ! -d "public/messages" ]; then \
        echo "=== Trying to find and copy messages files ===" && \
        if [ -d "messages" ]; then \
            echo "Found messages/ in root, copying to public/" && \
            mkdir -p public/messages && \
            cp -r messages/* public/messages/ && \
            ls -la public/messages/; \
        elif [ -d "frontend/public/messages" ]; then \
            echo "Found frontend/public/messages/, copying" && \
            mkdir -p public/messages && \
            cp -r frontend/public/messages/* public/messages/ && \
            ls -la public/messages/; \
        else \
            echo "ERROR: Cannot find messages directory anywhere" && \
            find . -type d -name "messages" 2>/dev/null; \
        fi \
    else \
        echo "public/messages/ already exists"; \
    fi

# Verify translation files exist before build
RUN echo "=== Final check before build ===" && \
    if [ -d "public/messages" ]; then \
        echo "public/messages/ exists" && \
        ls -la public/messages/ && \
        echo "JSON files count:" && \
        ls -1 public/messages/*.json | wc -l; \
    else \
        echo "ERROR: public/messages/ still not found after copy attempts"; \
    fi

# Build the application
RUN npm run build

# Verify translation files exist after build
RUN echo "=== Checking files after build ===" && \
    if [ -d "dist/messages" ]; then \
        echo "dist/messages/ exists" && \
        ls -la dist/messages/ && \
        echo "JSON files:" && \
        ls -1 dist/messages/*.json; \
    else \
        echo "ERROR: dist/messages/ directory not found after build"; \
    fi

# If messages directory doesn't exist in dist, copy it manually
RUN if [ ! -d "dist/messages" ]; then \
        echo "=== Copying messages directory manually ===" && \
        if [ -d "public/messages" ]; then \
            mkdir -p dist/messages && \
            cp -r public/messages/* dist/messages/ && \
            echo "Files copied successfully" && \
            ls -la dist/messages/; \
        else \
            echo "ERROR: public/messages/ not found, cannot copy" && \
            echo "Searching for messages files:" && \
            find . -name "*.json" -path "*/messages/*" 2>/dev/null | head -10; \
        fi \
    else \
        echo "dist/messages/ already exists, skipping copy"; \
    fi

# Production stage with nginx
FROM nginx:alpine

# Install wget for healthcheck
RUN apk add --no-cache wget

# Copy built files from builder stage
COPY --from=builder /app/dist /usr/share/nginx/html

# Verify files are copied correctly
RUN echo "=== Checking files in nginx container ===" && \
    if [ -d "/usr/share/nginx/html/messages" ]; then \
        echo "messages directory exists" && \
        ls -la /usr/share/nginx/html/messages/ && \
        echo "JSON files:" && \
        ls -la /usr/share/nginx/html/messages/*.json || echo "No JSON files found"; \
    else \
        echo "ERROR: messages directory not found in nginx html/" && \
        echo "Contents of /usr/share/nginx/html:" && \
        ls -la /usr/share/nginx/html/ | head -20; \
    fi

# Copy nginx configuration
COPY nginx-docker.conf /etc/nginx/conf.d/default.conf

# Expose port
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]